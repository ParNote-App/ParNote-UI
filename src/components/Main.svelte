<script>
  import Router from "routve";
  import md5 from "md5";
  import { _, locales, locale as currentLocale } from "svelte-i18n";
  import { onDestroy, onMount } from "svelte";

  import {
    checkLogin,
    loginStatus,
    LoginStates,
    setLogout,
  } from "../util/login.util";
  import ApiUtil from "../util/api.util";

  import RouterConfig from "../router.config";
  import RouterConfigLoggedIn from "../router.config.loggedIn";

  import Header from "./Header.svelte";
  import Footer from "./Footer.svelte";
  import PageLoading from "./PageLoading.svelte";

  import {
    isPageInitialized,
    isBasicDataInitialized,
    userData,
    forceNotLoggedInView,
  } from "../Store";

  import { show as showNoteModal } from "./modals/NoteModal.svelte";
  import Notes from "./Notes.svelte";
  import NoteModal from "./modals/NoteModal.svelte";

  let searching = false;
  let showSearch = false;
  let searchNotes = [];
  let query = "";
  let searchedQuery = "";

  let checkTime = 0;
  let interval;

  const showLoadingAlways = false;

  function showLoading(showLoadingAlways, isPageInitialized) {
    return showLoadingAlways || !isPageInitialized;
  }

  function logout() {
    loginStatus.set(LoginStates.LOADING);

    ApiUtil.post("auth/logout")
      .then(() => {
        setLogout();
        window.location = "/";
      })
      .catch(() => {
        setLogout();
        window.location = "/";
      });
  }

  function getBasicLoggedInData() {
    (function getData() {
      ApiUtil.post("loggedIn/initialData", {})
        .then((response) => {
          if (response.data.result === "ok") {
            userData.update((userData) => {
              userData.name = response.data.name;
              userData.surname = response.data.surname;
              userData.username = response.data.username;
              userData.email = response.data.email;

              return userData;
            });

            isBasicDataInitialized.set(true);
          } else {
            setTimeout(() => {
              getData();
            }, 500);
          }
        })
        .catch(() => {
          setTimeout(() => {
            getData();
          }, 500);
        });
    })();
  }

  function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
  }

  checkLogin(() => {
    getBasicLoggedInData();
  });

  function getMd5Hash(text) {
    return md5(text.toLowerCase());
  }

  function showNewNote() {
    showNoteModal();
  }

  function search() {
    showSearch = true;
    searching = true;

    (function searchData() {
      ApiUtil.post("notes/search", { query })
        .then((response) => {
          if (response.data.result === "ok") {
            searchNotes = [];

            response.data.notes.forEach((note) => {
              searchNotes.push(note);
            });

            searchedQuery = "" + query;

            searching = false;
          } else {
            setTimeout(() => {
              searchData();
            }, 500);
          }
        })
        .catch(() => {
          setTimeout(() => {
            searchData();
          }, 500);
        });
    })();
  }

  function clearResults() {
    showSearch = false;
  }

  onMount(() => {
    interval = setInterval(() => {
      checkTime += 1;
    }, 1000);
  });

  onDestroy(() => {
    clearInterval(interval);
  });

  export let hidden;
</script>

{#if $loginStatus === LoginStates.LOGGED_OUT || $forceNotLoggedInView}
  <Header />

  <div class="container-fluid h-100">
    <div class="row h-100">
      <div
        class="col-lg-6 col-12 h-100 d-flex h-100 flex-column justify-content-center"
      >
        <Router config="{RouterConfig}" />
      </div>
      <div class="col-6 h-100 bg-primary d-lg-flex d-none"></div>
    </div>
  </div>
  <Footer />
{/if}
{#if $loginStatus === LoginStates.LOGGED_IN && !$forceNotLoggedInView}
  <div hidden="{hidden}">
    <div class="d-flex flex-column min-vh-100">
      <nav class="navbar py-3">
        <div class="container">
          <div
            class="w-100 d-flex flex-row align-items-between align-items-center"
          >
            <a class="navbar-brand" href="/">
              <img
                src="/assets/img/logo.svg"
                width="30"
                height="30"
                class="d-inline-block align-top"
                alt="ParNote"
                title="ParNote"
              />
            </a>

            <button
              type="button"
              class="btn btn-link mr-2"
              on:click="{showNewNote}"
            >
              <i class="fa fa-plus"></i>
              <span class="ml-2 d-lg-inline d-none">{$_('main.new-note')}</span>
            </button>

            <form
              on:submit|preventDefault="{search}"
              class="d-flex flex-row mx-auto"
            >
              <input
                class="form-control border-0 bg-light rounded text-center text-primary search-input"
                type="search"
                placeholder="Find a note..."
                bind:value="{query}"
              />
              <button type="submit" class="btn btn-link">
                <i class="fa fa-search"></i>
              </button>
            </form>

            <div class="dropdown">
              <a
                class="nav-link"
                href="javascript:void(0);"
                id="navbarDropdown"
                role="button"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
              >
                {$_('language-name')}
                <i class="fas fa-angle-down"></i>
              </a>
              <div
                class="dropdown-menu position-absolute"
                aria-labelledby="navbarDropdown"
              >
                {#each $locales as locale}
                  <a
                    class="dropdown-item text-primary"
                    href="javascript:void(0);"
                    class:font-weight-bold="{$currentLocale
                      .toLowerCase()
                      .startsWith(locale)}"
                    on:click="{() => currentLocale.set(locale)}"
                  >{$_('language-name', { locale })}</a>
                {/each}
              </div>
            </div>
            <div class="dropdown ml-3">
              <a
                href="javascript:void(0);"
                class="nav-item"
                id="userMenu"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
              >
                <img
                  src="https://www.gravatar.com/avatar/{getMd5Hash($userData.email)}"
                  alt="{$userData.username}"
                  title="{$userData.username}"
                  width="32"
                  height="32"
                  class="border rounded-circle"
                />
              </a>
              <div
                class="dropdown-menu dropdown-menu-right shadow-sm"
                aria-labelledby="userMenu"
              >
                <h6 class="dropdown-header mb-0">
                  {capitalizeFirstLetter($userData.name)}
                  {capitalizeFirstLetter($userData.surname)}
                </h6>
                <h8 class="dropdown-header mb-1">@{$userData.username}</h8>
                <a class="dropdown-item" href="/settings"><i
                    class="fas fa-cog mr-2"
                  ></i>
                  {$_('main.settings')}</a>
                <a
                  class="dropdown-item text-danger"
                  href="javascript:void(0);"
                  on:click="{() => logout()}"
                >
                  <i class="fas fa-sign-out-alt mr-2"></i>
                  {$_('main.logout')}</a>
              </div>
            </div>
          </div>
        </div>
      </nav>

      <main class="flex-fill">
        <div class="container">
          {#if showLoading(showLoadingAlways, $isPageInitialized) || searching}
            <PageLoading />
          {/if}

          <Router
            hidden="{showLoading(showLoadingAlways, $isPageInitialized) || showSearch}"
            config="{RouterConfigLoggedIn}"
          />

          {#if showSearch && !searching}
            <div class="d-flex flex-row">
              <h1>Searched: <strong>{searchedQuery}</strong></h1>

              <a class="ml-auto my-auto" href="javascript:void(0);" on:click={clearResults}>
                <h3>Clear Results</h3>
              </a>
            </div>

            <div class="container">
              <Notes
                count="{searchNotes.length}"
                notes="{searchNotes}"
                status="{4}"
                checkTime="{checkTime}"
              />
            </div>
          {/if}
        </div>
      </main>

      <footer>
        <div class="container d-flex">
          <a
            href="/terms-and-policy"
            target="_blank"
          >{$_('main.terms-and-policy')}</a>
          <p class="ml-auto">ParNote &copy; 2020</p>
        </div>
      </footer>
    </div>
  </div>

  <NoteModal />
{/if}
